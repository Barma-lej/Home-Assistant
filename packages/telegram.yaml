# Telegram Bot configuration
# telegram_bot:
#   - platform: polling
#     # - platform: broadcast
#     api_key: !secret telegram_api_key
#     allowed_chat_ids:
#       - !secret telegram_channel
#       - !secret telegram_bot_familie
#       - !secret telegram_bot_anatolij
#       - !secret telegram_bot_natalja
#       - !secret telegram_bot_kristina
#       - !secret telegram_bot_veronika

# Notify ############################################################
# notify:
#   - name: telegram_schick_home
#     platform: telegram
#     chat_id: !secret telegram_channel

#   - name: telegram_bot_familie
#     platform: telegram
#     chat_id: !secret telegram_bot_familie

#   - name: telegram_bot_anatolij
#     platform: telegram
#     chat_id: !secret telegram_bot_anatolij

#   - name: telegram_bot_natalja
#     platform: telegram
#     chat_id: !secret telegram_bot_natalja

#   - name: telegram_bot_kristina
#     platform: telegram
#     chat_id: !secret telegram_bot_kristina

#   - name: telegram_bot_veronika
#     platform: telegram
#     chat_id: !secret telegram_bot_veronika

# Automation ########################################################
automation:
  # Manage queries of telegram
  - id: telegram_control
    alias: "Telegram - Control"
    triggers:
      - trigger: event
        event_type: telegram_callback
        event_data: {}
      - trigger: event
        event_type: telegram_command
        event_data: {}

    actions:
      - choose:
          # Start
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.command == '/start' }}"
            sequence:
              - action: telegram_bot.send_message
                data:
                  target: "{{ trigger.event.data.chat_id }}"
                  message: "Tastatur aktiviert"
                  keyboard:
                    # - "/wandlicht, /wohnlicht, /kuechenlicht"
                    # - "/essecke, /ambiente_wohnen, /ambiente_kueche"
                    # - "/rollade_1, /rollade_2, /rollade_3, /rollade_4"
                    - "/alarm, /tor, /start, /help"

              - action: script.telegram_callback
                data:
                  target: "{{ trigger.event.data.chat_id }}"
                  message_id: "{{ trigger.event.data.message.message_id if trigger.event.event_type == 'telegram_callback' else 1000 }}"
                  message: |
                    WÃ¤hle das Symbol [/] unten und dann eine Aktion aus.
                    /start - Zeigt diese Nachricht
                    /help - Zeigt eine Nachricht mit Befehlen an
          # Help
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.command == '/help' }}"
            sequence:
              - action: script.telegram_callback
                data:
                  target: "{{ trigger.event.data.chat_id }}"
                  message_id: "{{ trigger.event.data.message.message_id if trigger.event.event_type == 'telegram_callback' else 1000 }}"
                  message: |
                    *Tor Ã¶ffnen/schliessen:*
                    - /tor - Garage Ã¶ffnen/schliessen
                    - /torteil - Garage teilweise Ã¶ffnen/schliessen

                    *Licht ein/aus:*
                    - /wandlicht - Wandlicht
                    - /wohnlicht - Wohnlicht
                    - /kuechenlicht - KÃ¼chenlicht
                    - /essecke - Esseckenlicht
                    - /ambiente\_wohnen - Ambiente Wohnzimmer
                    - /ambiente\_kueche - Ambiente KÃ¼che

                    *Rollade Ã¶ffnen/schliessen:*
                    - /rollade\_1 - Rollade 1
                    - /rollade\_2 - Rollade 2
                    - /rollade\_3 - Rollade 3
                    - /rollade\_4 - Rollade Terrasse

                    *Allgemein:*
                    - /start - Zeigt die BegrÃ¼ÃŸungsnachricht
                    - /help - Zeigt eine Nachricht mit Befehlen an

# Scripts ###########################################################
script:
  telegram_callback:
    alias: Telegram - Callback
    icon: mdi:send
    mode: parallel
    sequence:
      - action: telegram_bot.send_message
        data:
          target: "{{ target }}"
          message: "{{ message }}"
          inline_keyboard:
            - "{{ (states('light.sonoffpow_01') == 'on') | iif('ğŸŸ¢', 'ğŸ”´') }} Wandlicht:/wandlicht,
              {{ (states('light.shellyswitch25_10c7c3_channel_1') == 'on') | iif('ğŸŸ¢', 'ğŸ”´') }} Wohnen:/wohnlicht,
              {{ (states('light.shellyswitch25_10a36d_channel_1') == 'on') | iif('ğŸŸ¢', 'ğŸ”´') }} KÃ¼che:/kuechenlicht"
            - "{{ (states('light.shellyswitch25_10a36d_channel_2') == 'on') | iif('ğŸŸ¢', 'ğŸ”´') }} Essecke:/essecke,
              {{ (states('light.sonoffpow_02') == 'on') | iif('ğŸŸ¢', 'ğŸ”´') }} Ambiwohnen:/ambiente_wohnen,
              {{ (states('light.sonoffpow_04') == 'on') | iif('ğŸŸ¢', 'ğŸ”´') }} AmbikÃ¼che:/ambiente_kueche"
            - "{% set r1 = state_attr('cover.rollade_1', 'current_position') | int %}
              {% set r2 = state_attr('cover.rollade_2', 'current_position') | int %}
              {% set r3 = state_attr('cover.rollade_3', 'current_position') | int %}
              {{ (r1 < 95) | iif((r1 < 20) | iif('ğŸ”’', 'ğŸªŸ'~r1~'%'), 'ğŸªŸ') }} Rollade 1:/rollade_1,
              {{ (r2 < 95) | iif((r2 < 20) | iif('ğŸ”’', 'ğŸªŸ'~r2~'%'), 'ğŸªŸ') }} Rollade 2:/rollade_2,
              {{ (r3 < 95) | iif((r3 < 20) | iif('ğŸ”’', 'ğŸªŸ'~r3~'%'), 'ğŸªŸ') }} Rollade 3:/rollade_3"
            - "{% set r4 = state_attr('cover.rollade_4', 'current_position') | int %}
              {{ (r4 < 95) | iif((r4 < 20) | iif('ğŸ”’', 'ğŸªŸ'~r4~'%'), 'ğŸªŸ') }} Terrasse:/rollade_4,
              {{ ( states('sensor.torposition') | int > 0 ) | iif( 'ğŸš—' ~ states('sensor.torposition') | round(0) ~ '%' , 'ğŸ”’' ) }} Tor:/tor,
              {{ ( states('sensor.torposition') | int > 0 ) | iif( 'ğŸš—', 'ğŸ”’' ) }} Tortel:/torteil"
            - "{{ (states('input_boolean.alarm_indoor') == 'on') | iif('ğŸš¨', 'ğŸ”’') }} Alarm:/alarm,
              Home:/start,
              Hilfe:/help"

      - condition: template
        value_template: "{{ (message_id is defined) and (message_id != 1000) }}"

      - action: telegram_bot.delete_message
        data:
          message_id: "{{ message_id }}"
          chat_id: "{{ target }}"

      # ğŸ”´ğŸŸ¢ğŸ”“ğŸ”’âšª
# wandlicht - Wandlicht ein/aus
# wohnlicht - Wohnlicht ein/aus
# kuechenlicht - KÃ¼chenlicht ein/aus
# essecke - Esseckenlicht ein/aus
# ambiente_wohnen - Ambiente Wohnzimmer ein/aus
# ambiente_kueche - Ambiente KÃ¼che ein/aus
# rollade_1 - Rollade 1 Ã¶ffnen/schliessen
# rollade_2 - Rollade 2 Ã¶ffnen/schliessen
# rollade_3 - Rollade 3 Ã¶ffnen/schliessen
# rollade_4 - Rollade Hinten Ã¶ffnen/schliessen
# tor - Garage Ã¶ffnen/schliessen
# torteil - Garage teilweise Ã¶ffnen/schliessen
# start - Zeigt die BegrÃ¼ÃŸungsnachricht
# help - Zeigt eine Nachricht mit Befehlen an

# Emojis reference for easy maintenance:
# ğŸŸ¢ - Active/On/Open
# ğŸ”´ - Inactive/Off/Closed
# ğŸ”’ - Locked/Secured/Closed
# ğŸ”“ - Unlocked/Unsecured/Open
# âŒ - Error/Unavailable
# âšª - Unknown/Neutral
# ğŸ’¡ - Light
# ğŸªŸ - Window/Cover
# ğŸš— - Garage/Car
# ğŸš¨ - Alarm/Security
# ğŸ“Š - Status/Statistics
# ğŸ”„ - Refresh/Update
# ğŸ”™ - Back/Return
# â“ - Help/Question
# ğŸ  - Home/Main
# ğŸ• - Time/Clock
# â¬†ï¸ - Up/Open
# â¬‡ï¸ - Down/Close
# â¸ï¸ - Stop/Pause
# â¹ï¸ - Stop (alternative)
