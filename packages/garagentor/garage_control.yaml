# Garage
# Control

# Template Sensors
template:
  - binary_sensor:
      - name: "Garage Open Too Long"
        unique_id: garage_open_too_long # Unique ID for Home Assistant
        state: >
          {{ states('cover.tor_tor') == 'open' and 
            state_attr('cover.tor_tor', 'current_position') | int(0) > 13 }}
        delay_on:
          minutes: 30 # Turns on after the condition is true for 30 minutes
        # Turns off as soon as the condition is false

# Automations
automation:
  - id: telegram_tor
    alias: "Telegram - Tor"
    mode: restart
    triggers:
      - trigger: event
        event_type: telegram_command
        event_data:
          command: "/tor"
      - trigger: event
        event_type: telegram_command
        event_data:
          command: "/torteil"

      - trigger: event
        event_type: telegram_callback
        event_data:
          command: "/tor"
      - trigger: event
        event_type: telegram_callback
        event_data:
          command: "/torteil"

    actions:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.command == '/tor' }}"
            sequence:
              - action: button.press
                target:
                  entity_id: button.tor_tor

              - wait_for_trigger:
                  - trigger: state
                    entity_id: cover.tor_tor
                timeout: "00:00:05"
                continue_on_timeout: true

              - action: script.telegram_callback
                data:
                  target: "{{ trigger.event.data.chat_id }}"
                  message_id: "{{ trigger.event.data.message.message_id if trigger.event.event_type == 'telegram_callback' else 1000 }}"
                  message: "{{ state_attr('button.tor_tor', 'friendly_name') }} - {{ state_attr('cover.tor_tor', 'current_position') }}%"

          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.command == '/torteil' }}"
            sequence:
              - action: button.press
                target:
                  entity_id: button.tor_luftung

              - wait_for_trigger:
                  - trigger: state
                    entity_id: cover.tor_tor
                timeout: "00:00:05"
                continue_on_timeout: true

              - action: script.telegram_callback
                data:
                  target: "{{ trigger.event.data.chat_id }}"
                  message_id: "{{ trigger.event.data.message.message_id if trigger.event.event_type == 'telegram_callback' else 1000 }}"
                  message: "{{ state_attr('button.tor_luftung', 'friendly_name') }} - {{ state_attr('cover.tor_tor', 'current_position') }}%"

  - id: garage_auto_close
    alias: "Garage - Autoschlie√üen"
    description: "–ì–∞—Ä–∞–∂ - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (–æ—Ç–∫—Ä—ã—Ç >13% –±–æ–ª–µ–µ 30 –º–∏–Ω, —Ç–µ–º–Ω–æ, —Å–≤–µ—Ç –≤—ã–∫–ª)"
    mode: single # –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤

    # Triggers when any of the key conditions might lead to an auto-close scenario
    triggers:
      - trigger: state
        entity_id: binary_sensor.garage_open_too_long # Helper sensor turns on
        to: "on"
      - trigger: state
        entity_id: sun.sun
        to: "below_horizon" # It becomes dark
      - trigger: state
        entity_id: binary_sensor.all_lights_off
        to: "on" # All relevant lights turn off
      - trigger: homeassistant
        event: start # Check conditions when Home Assistant starts

    condition:
      # All these conditions must be true for the actions to run
      - condition: state
        entity_id: sun.sun
        state: "below_horizon" # –£—Å–ª–æ–≤–∏–µ "—Ç–µ–º–Ω–æ"
      - condition: state
        entity_id: binary_sensor.all_lights_off # –£—Å–ª–æ–≤–∏–µ "–≤–µ–∑–¥–µ –≤—ã–∫–ª—é—á–µ–Ω —Å–≤–µ—Ç"
        state: "on" # 'on' –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤—Å–µ —Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω—ã
      - condition: state
        entity_id: binary_sensor.garage_open_too_long # Garage has been open >13% for over 30 mins
        state: "on"

    actions:
      - variables:
          initial_pos: "{{ state_attr('cover.tor_tor', 'current_position') | int }}"

      - action: telegram_bot.send_message
        data:
          target: !secret telegram_channel
          message: "üöó–ì–∞—Ä–∞–∂ –æ—Ç–∫—Ä—ã—Ç —É–∂–µ 30 –º–∏–Ω—É—Ç, —Å–µ–π—á–∞—Å —Ç–µ–º–Ω–æ –∏ —Å–≤–µ—Ç –≤–µ–∑–¥–µ –≤—ã–∫–ª—é—á–µ–Ω. –ü–ª–∞–Ω–∏—Ä—É—é –∑–∞–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É. –°–≤–µ—Ç –±—É–¥–µ—Ç –º–∏–≥–∞—Ç—å. –ï—Å–ª–∏ –≤–æ—Ä–æ—Ç–∞ —Å–¥–≤–∏–Ω—É—Ç—Å—è –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 10%, –∑–∞–∫—Ä—ã—Ç–∏–µ –æ—Ç–º–µ–Ω–∏—Ç—Å—è."
      # –ú–∏–Ω—É—Ç–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ —Å –º–∏–≥–∞–Ω–∏–µ–º —Å–≤–µ—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ—Ç–º–µ–Ω—ã
      - alias: "–ú–∏–Ω—É—Ç–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ —Å –º–∏–≥–∞–Ω–∏–µ–º –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ—Ç–º–µ–Ω—ã"
        repeat:
          count: 12 # 12 —Ü–∏–∫–ª–æ–≤ * 5 —Å–µ–∫—É–Ω–¥ = 60 —Å–µ–∫—É–Ω–¥
          sequence:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–º–µ–Ω—ã –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –º–∏–≥–∞–Ω–∏–µ–º
            - choose:
                - conditions:
                    - condition: template
                      value_template: >
                        {% set current_pos = state_attr('cover.tor_tor', 'current_position') | int(0) %}
                        {{ (current_pos - initial_pos) | abs > 10 }}
                  sequence:
                    - action: telegram_bot.send_message
                      data:
                        target: !secret telegram_channel
                        message: "üöó–ì–∞—Ä–∞–∂ - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –≥–∞—Ä–∞–∂–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤–æ—Ä–æ—Ç –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 10%."
                    - stop: "–ó–∞–∫—Ä—ã—Ç–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ –∏–∑-–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–æ–∂–µ–Ω–∏—è –≤–æ—Ä–æ—Ç"
            # –ú–∏–≥–∞–Ω–∏–µ —Å–≤–µ—Ç–æ–º
            - action: light.turn_on
              target:
                entity_id: light.sonoffbnsz01
              data: {} # –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è —è–≤–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ light.turn_on —Ç—Ä–µ–±—É–µ—Ç
            - delay:
                seconds: 2.5 # –°–≤–µ—Ç –≤–∫–ª—é—á–µ–Ω
            - action: light.turn_off
              target:
                entity_id: light.sonoffbnsz01
              data: {} # –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è —è–≤–Ω–æ—Å—Ç–∏
            - delay:
                seconds: 2.5 # –°–≤–µ—Ç –≤—ã–∫–ª—é—á–µ–Ω (–æ–±—â–∏–π —Ü–∏–∫–ª 5 —Å–µ–∫—É–Ω–¥)

      # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∏–ª–∏ –æ—Ç–º–µ–Ω–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–æ–º–µ–Ω—Ç)
      - condition: template
        value_template: >
          {% set current_pos = state_attr('cover.tor_tor', 'current_position') | int(0) %}
          {{ (current_pos - initial_pos) | abs <= 10 }}
      - condition: template # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤–æ—Ä–æ—Ç–∞ –≤—Å–µ –µ—â–µ –æ—Ç–∫—Ä—ã—Ç—ã –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —É—Å–ª–æ–≤–∏—é
        value_template: "{{ states('cover.tor_tor') == 'open' and state_attr('cover.tor_tor', 'current_position') | int(0) > 13 }}"

      - action: telegram_bot.send_message
        data:
          target: !secret telegram_channel
          message: "üöó–ì–∞—Ä–∞–∂ - –ù–∞—á–∏–Ω–∞—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –≥–∞—Ä–∞–∂–∞..."

      # –ü–æ–ø—ã—Ç–∫–∞ 1
      - alias: "–ó–∞–∫—Ä—ã—Ç–∏–µ –≥–∞—Ä–∞–∂–∞ - –ü–æ–ø—ã—Ç–∫–∞ 1"
        action: button.press
        target:
          entity_id: button.tor_tor

      - delay:
          seconds: 3 # –î–∞—Ç—å –≤—Ä–µ–º—è –Ω–∞ —Ä–µ–∞–∫—Ü–∏—é –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

      - choose:
          # –£—Å–ø–µ—Ö: –≤–æ—Ä–æ—Ç–∞ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –∏–ª–∏ —É–∂–µ –∑–∞–∫—Ä—ã—Ç—ã
          - conditions:
              - "{{ states('cover.tor_tor') == 'closing' or states('cover.tor_tor') == 'closed' }}"
            sequence:
              - action: telegram_bot.send_message
                data:
                  target: !secret telegram_channel
                  message: "üöó–ì–∞—Ä–∞–∂ - –í–æ—Ä–æ—Ç–∞ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è/–∑–∞–∫—Ä—ã—Ç—ã –ø–æ—Å–ª–µ 1-–π –∫–æ–º–∞–Ω–¥—ã."
          # –ù–µ—É–¥–∞—á–∞: –≤–æ—Ä–æ—Ç–∞ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –∏–ª–∏ –≤—Å–µ –µ—â–µ –æ—Ç–∫—Ä—ã—Ç—ã (–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã)
          - conditions:
              - "{{ states('cover.tor_tor') == 'opening' or states('cover.tor_tor') == 'open' }}"
            sequence:
              - action: telegram_bot.send_message
                data:
                  target: !secret telegram_channel
                  message: "üöó–ì–∞—Ä–∞–∂ - –ü–æ—Å–ª–µ 1-–π –∫–æ–º–∞–Ω–¥—ã, –≤–æ—Ä–æ—Ç–∞ {{ states('cover.tor_tor') }}. –û—Ç–ø—Ä–∞–≤–ª—è—é 2-—é –∫–æ–º–∞–Ω–¥—É..."
              # –ü–æ–ø—ã—Ç–∫–∞ 2:
              # –ï—Å–ª–∏ –±—ã–ª–æ 'opening', —ç—Ç–æ –±—É–¥–µ—Ç 'stop'.
              # –ï—Å–ª–∏ –±—ã–ª–æ 'open' (stopped), —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 'close'.
              - alias: "–ó–∞–∫—Ä—ã—Ç–∏–µ –≥–∞—Ä–∞–∂–∞ - –ü–æ–ø—ã—Ç–∫–∞ 2"
                action: button.press
                target:
                  entity_id: button.tor_tor
              - delay:
                  seconds: 3

              - choose:
                  # –£—Å–ø–µ—Ö —Å–æ 2-–π –ø–æ–ø—ã—Ç–∫–∏
                  - conditions:
                      - "{{ states('cover.tor_tor') == 'closing' or states('cover.tor_tor') == 'closed' }}"
                    sequence:
                      - action: telegram_bot.send_message
                        data:
                          target: !secret telegram_channel
                          message: "üöó–ì–∞—Ä–∞–∂ - –í–æ—Ä–æ—Ç–∞ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è/–∑–∞–∫—Ä—ã—Ç—ã –ø–æ—Å–ª–µ 2-–π –∫–æ–º–∞–Ω–¥—ã."
                  # –ù–µ—É–¥–∞—á–∞: –≤–æ—Ä–æ—Ç–∞ –≤—Å–µ –µ—â–µ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è, –∏–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã (–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã) –ø–æ—Å–ª–µ 2-–π –ø–æ–ø—ã—Ç–∫–∏
                  - conditions:
                      - "{{ states('cover.tor_tor') == 'opening' or states('cover.tor_tor') == 'open' }}"
                    sequence:
                      - action: telegram_bot.send_message
                        data:
                          target: !secret telegram_channel
                          message: "üöó–ì–∞—Ä–∞–∂ - –ü–æ—Å–ª–µ 2-–π –∫–æ–º–∞–Ω–¥—ã, –≤–æ—Ä–æ—Ç–∞ {{ states('cover.tor_tor') }}. –û—Ç–ø—Ä–∞–≤–ª—è—é 3-—é –∫–æ–º–∞–Ω–¥—É..."
                      # –ü–æ–ø—ã—Ç–∫–∞ 3:
                      # –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±—ã–ª–∞: open -> stop -> (—ç—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å close)
                      - alias: "–ó–∞–∫—Ä—ã—Ç–∏–µ –≥–∞—Ä–∞–∂–∞ - –ü–æ–ø—ã—Ç–∫–∞ 3"
                        action: button.press
                        target:
                          entity_id: button.tor_tor
                      - delay:
                          seconds: 3 # –î–∞—Ç—å –≤—Ä–µ–º—è –Ω–∞ —Ä–µ–∞–∫—Ü–∏—é
                      - action: telegram_bot.send_message
                        data:
                          target: !secret telegram_channel
                          message: "üöó–ì–∞—Ä–∞–∂ - 3-—è –∫–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: {{ states('cover.tor_tor') }}. –û–∂–∏–¥–∞—é –ø–æ–ª–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è."
                default: # –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ 2-–π –ø–æ–ø—ã—Ç–∫–∏
                  - action: telegram_bot.send_message
                    data:
                      target: !secret telegram_channel
                      message: "üöó–ì–∞—Ä–∞–∂ - –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Ä–æ—Ç {{ states('cover.tor_tor') }} –ø–æ—Å–ª–µ 2-–π –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è."
        default: # –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ 1-–π –ø–æ–ø—ã—Ç–∫–∏
          - action: telegram_bot.send_message
            data:
              target: !secret telegram_channel
              message: "üöó–ì–∞—Ä–∞–∂ - –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Ä–æ—Ç {{ states('cover.tor_tor') }} –ø–æ—Å–ª–µ 1-–π –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è."

      # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –≤–æ—Ä–æ—Ç (–º–æ–Ω–∏—Ç–æ—Ä–∏–º cover.tor_tor)
      - wait_for_trigger:
          - trigger: state
            entity_id: cover.tor_tor
            to: "closed"
        timeout:
          minutes: 2 # –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è (–Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥ —Å–≤–æ–∏ –≤–æ—Ä–æ—Ç–∞)
        continue_on_timeout: true # –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–∞–π–º–∞—É—Ç

      # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
      - variables:
          garage_closed_successfully: "{{ wait.trigger is not none and states('cover.tor_tor') == 'closed' }}"
      - action: telegram_bot.send_message
        data:
          target: !secret telegram_channel
          message: >
            {% if garage_closed_successfully %}
              üöó–ì–∞—Ä–∞–∂ —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
            {% else %}
              üöó–ì–∞—Ä–∞–∂ –Ω–µ –∑–∞–∫—Ä—ã–ª—Å—è (—Å–æ—Å—Ç–æ—è–Ω–∏–µ: {{ states('cover.tor_tor') }}, –ø–æ–∑–∏—Ü–∏—è: {{ state_attr('cover.tor_tor', 'current_position') }}%) –≤ —Ç–µ—á–µ–Ω–∏–µ 2 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è.
            {% endif %}
