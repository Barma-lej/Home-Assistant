- id: tasmota_state_on_startup
  alias: Tasmota - Power state on HA startup
  trigger:
  - event: start
    platform: homeassistant
  action:
  - data:
      payload: '1'
      topic: sonoffs/cmnd/state
    service: mqtt.publish
  - data:
      payload: '1'
      topic: sonoffs/tele/STATE
    service: mqtt.publish
- id: rolladen_auf
  alias: Rolladen - Auf
  description: ''
  trigger:
  - event: sunrise
    offset: 03:00:00
    platform: sun
  condition: []
  action:
  - data:
      entity_id: cover.rolladen
      position: 100
    service: cover.set_cover_position
  - data:
      message: Rolladen geöffnet
      title: "\U0001F53C Rolladen"
    service: notify.telegram_schick_home
  mode: single
- id: rolladen_zu
  alias: Rolladen - Zu
  description: ''
  trigger:
  - event: sunset
    offset: 01:30:00
    platform: sun
  condition: []
  action:
  - data:
      entity_id: cover.rolladen
      position: 0
    service: cover.set_cover_position
  - data:
      message: Rolladen geschlossen
      title: "\U0001F53D Rolladen"
    service: notify.telegram_schick_home
  mode: single
- id: garagenlicht_einschalten
  alias: Garage - Licht einschalten
  description: Garagenlicht einschalten nach der Sonnenunregang oder wenn es dunkel
    ist
  trigger:
  - type: value
    platform: device
    device_id: db8b13c767d84865a607aca77975a221
    entity_id: sensor.torposition
    domain: sensor
    above: 50
    for:
      hours: 0
      minutes: 0
      seconds: 5
      milliseconds: 0
  condition:
  - condition: or
    conditions:
    - condition: sun
      before: sunrise
      before_offset: 00:15:00
    - condition: sun
      after: sunset
      after_offset: -00:15:00
  action:
  - type: turn_on
    device_id: 63713a671de1472e84d5832bcb399f0e
    entity_id: light.sonoffbnsz01
    domain: light
    brightness_pct: 95
  - delay:
      hours: 0
      minutes: 10
      seconds: 0
      milliseconds: 0
  - type: turn_off
    device_id: 63713a671de1472e84d5832bcb399f0e
    entity_id: light.sonoffbnsz01
    domain: light
  mode: restart
- id: garagenlicht_ausschalten
  alias: Garage - Licht ausschalten
  description: Garagenlicht ausschalten wenn das Garagentor geschlossen wurde
  trigger:
  - platform: state
    entity_id: binary_sensor.tor_offen
    to: 'off'
    for:
      hours: 0
      minutes: 0
      seconds: 5
  - platform: state
    entity_id: input_boolean.torteil
    to: 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 5
  condition: []
  action:
  - type: turn_off
    device_id: 63713a671de1472e84d5832bcb399f0e
    entity_id: light.sonoffbnsz01
    domain: light
  mode: restart
- id: camera_garage_richtung
  alias: Camera - Garage Richtung
  description: Направление камеры в зависимости от положения гаражных ворот
  trigger:
  - type: value
    platform: device
    device_id: db8b13c767d84865a607aca77975a221
    entity_id: sensor.torposition
    domain: sensor
    above: 30
    for:
      hours: 0
      minutes: 0
      seconds: 5
  - type: value
    platform: device
    device_id: db8b13c767d84865a607aca77975a221
    entity_id: sensor.torposition
    domain: sensor
    below: 20
    for:
      hours: 0
      minutes: 0
      seconds: 5
  - platform: state
    entity_id: binary_sensor.tor_offen
    to: 'off'
    for:
      hours: 0
      minutes: 0
      seconds: 3
  - platform: state
    entity_id: input_boolean.torteil
    to: 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 5
  condition: []
  action:
  - choose:
    - conditions:
      - type: is_value
        condition: device
        device_id: db8b13c767d84865a607aca77975a221
        entity_id: sensor.torposition
        domain: sensor
        above: 30
      sequence:
      - service: reolink_cctv.ptz_control
        data:
          entity_id: camera.garage
          command: TOPOS
          preset: 1
    - conditions:
      - type: is_value
        condition: device
        device_id: db8b13c767d84865a607aca77975a221
        entity_id: sensor.tor_distanz
        domain: sensor
        below: 20
      sequence:
      - service: reolink_cctv.ptz_control
        data:
          entity_id: camera.garage
          command: TOPOS
          preset: 2
      - delay:
          hours: 0
          minutes: 0
          seconds: 30
          milliseconds: 0
      - service: reolink_cctv.ptz_control
        data:
          entity_id: camera.garage
          command: TOPOS
          preset: 2
    default: []
  mode: restart
- id: '1651786976779'
  alias: Aktualisierung - Benachrichtigung
  description: Aktualisirungsbenachrichtigung
  use_blueprint:
    path: mdegat01/update_notifications.yaml
    input:
      reminder_hours: '6'
      update_entities:
      - update.duck_dns_update
      - update.esphome_update
      - update.fritz_box_7490_fritz_os
      - update.ftp_update
      - update.home_assistant_core_update
      - update.home_assistant_supervisor_update
      - update.mosquitto_broker_update
      - update.samba_share_update
      - update.sqlite_web_update
      - update.studio_code_server_update
      - update.tasmoadmin_update
      - update.wled_soundreactive_firmware
      mobile_app_device: 52dde1dbd0bd045e5b6181020e86c549
      run_config_check: false
      send_to_ha: true
      take_backup: true
- id: '1661601350027'
  alias: Считана метка Red
  description: ''
  trigger:
  - platform: tag
    tag_id: 4d4d9d64-59ff-4a65-8d8c-d1a088f46599
  condition: []
  action:
  - service: switch.toggle
    data: {}
    target:
      entity_id: switch.tor
  mode: single
- id: '1661607357549'
  alias: Считана метка Green
  description: ''
  trigger:
  - platform: tag
    tag_id: 25cf4f63-039d-47b6-8012-32e9e6cb831d
  condition: []
  action:
  - service: light.toggle
    data: {}
    target:
      entity_id: light.sonoffpow_01
  mode: single
- id: '1668006470208'
  alias: Garage - Coming home
  description: Open tor if Tiguan is coming to home
  trigger:
  - platform: device
    device_id: 52dde1dbd0bd045e5b6181020e86c549
    domain: device_tracker
    entity_id: device_tracker.sm_g996b
    type: enters
    zone: zone.home
  condition:
  - condition: state
    entity_id: sensor.sm_g996b_bluetooth_connection
    attribute: connected_paired_devices
    state: B4:EC:02:94:8A:CF (VW BT 1505)
    enabled: false
  - condition: numeric_state
    entity_id: sensor.torposition
    below: 10
  - condition: or
    conditions:
    - condition: template
      value_template: '{{ "68:4E:05:63:56:10 (VOLKSWAGEN-21ED)" in state_attr("sensor.sm_g996b_bluetooth_connection",
        "connected_paired_devices") }}'
    - condition: template
      value_template: '{{ "B4:EC:02:94:8A:CF (VW BT 1505)" in state_attr("sensor.sm_g996b_bluetooth_connection",
        "connected_paired_devices") }}'
  action:
  - service: switch.turn_on
    data: {}
    target:
      entity_id: switch.tor
  - service: notify.mobile_app_sm_g996b
    data:
      message: TTS
      title: Garage
      data:
        ttl: 0
        priority: high
        media_stream: alarm_stream_max
        tts_text: Die Garage öffnet
  mode: single
- id: '1668017327174'
  alias: Garage - Leaving home
  description: Close tor if Tiguan is leaving home
  trigger:
  - platform: device
    device_id: 52dde1dbd0bd045e5b6181020e86c549
    domain: device_tracker
    entity_id: device_tracker.sm_g996b
    type: leaves
    zone: zone.home
  condition:
  - condition: state
    entity_id: sensor.sm_g996b_bluetooth_connection
    attribute: connected_paired_devices
    state: B4:EC:02:94:8A:CF (VW BT 1505)
    enabled: false
  - condition: or
    conditions:
    - condition: template
      value_template: '{{ "68:4E:05:63:56:10 (VOLKSWAGEN-21ED)" in state_attr("sensor.sm_g996b_bluetooth_connection",
        "connected_paired_devices") }}'
    - condition: template
      value_template: '{{ "B4:EC:02:94:8A:CF (VW BT 1505)" in state_attr("sensor.sm_g996b_bluetooth_connection",
        "connected_paired_devices") }}'
  - condition: numeric_state
    entity_id: sensor.torposition
    above: 5
  action:
  - service: switch.turn_on
    data: {}
    target:
      entity_id: switch.tor
  - service: notify.mobile_app_sm_g996b
    data:
      message: TTS
      title: Garage
      data:
        ttl: 0
        priority: high
        media_stream: alarm_stream_max
        tts_text: Die Garage schlisst
  - wait_for_trigger:
    - platform: numeric_state
      entity_id: sensor.torposition
      for:
        hours: 0
        minutes: 0
        seconds: 5
      below: 6
    timeout:
      hours: 0
      minutes: 0
      seconds: 30
      milliseconds: 0
    continue_on_timeout: false
  - service: notify.mobile_app_sm_g996b
    data:
      message: TTS
      title: Garage
      data:
        ttl: 0
        priority: high
        media_stream: alarm_stream_max
        tts_text: Die Garage ist geschlossen
  mode: single
- id: '1674331541169'
  alias: 3D - Druck ist fertig
  description: ''
  trigger:
  - platform: numeric_state
    entity_id: sensor.octoprint_job_percentage
    above: 99.999999
    enabled: false
  - platform: state
    entity_id:
    - sensor.octoprint_print_status
    from: Printing
    to: Finishing
    enabled: false
  - platform: state
    entity_id:
    - sensor.printer_3d_state
    from: printing
    for:
      hours: 0
      minutes: 10
      seconds: 0
  condition: []
  action:
  - service: notify.telegram_schick_home
    data:
      message: "\U0001F3ED 3D Druck ist fertig"
      data:
        photo:
        - url: http://192.168.2.18/plugin/UltimakerFormatPackage/thumbnail/{{ states('sensor.octoprint_print_file')
            | replace(' ','%20') | replace('gcode','png') }}
          caption: "\U0001F3ED 3D Druck ist fertig"
    enabled: false
  - wait_for_trigger:
    - platform: state
      entity_id:
      - sensor.octoprint_last_event
      to: MovieDone
    timeout:
      hours: 0
      minutes: 10
      seconds: 0
      milliseconds: 0
    enabled: false
  - wait_for_trigger:
    - platform: numeric_state
      entity_id: sensor.octoprint_actual_tool0_temp
      below: 70
    timeout:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
    enabled: false
  - if:
    - condition: state
      entity_id: sensor.octoprint_print_status
      state: Operational
    then:
    - service: switch.turn_off
      data: {}
      target:
        entity_id: switch.tuyaplug1
    - service: notify.telegram_schick_home
      data:
        message: "\U0001F3ED 3D Druck ist ausgeschaltet"
    enabled: false
  - service: notify.telegram_schick_home
    data:
      message: "\U0001F3ED 3D Druck ist fertig"
      data:
        photo:
        - url: http://192.168.2.18:7125/server/files/gcodes/{{ state_attr('sensor.printer_3d_file_metadata','thumbnails')[1]['relative_path']
            }}
          caption: "\U0001F3ED 3D Druck ist fertig"
  - wait_for_trigger:
    - platform: numeric_state
      entity_id: sensor.printer_3d_hotend_actual
      below: 70
    timeout:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
    enabled: true
  - if:
    - condition: template
      value_template: '{{ not is_state(''sensor.printer_3d_state'',''printing'') }}'
    then:
    - service: switch.turn_off
      data: {}
      target:
        entity_id: switch.tuyaplug1
    - service: notify.telegram_schick_home
      data:
        message: "\U0001F3ED 3D Drucker ist ausgeschaltet"
  mode: single
- id: '1674336725023'
  alias: Erinnerung - Mühlabfuhr
  description: ''
  use_blueprint:
    path: westenberg/garbage-reminder.yaml
    input:
      garbage_sensor_1: sensor.bioabfall
      garbage_sensor_2: sensor.leichtverpackungen
      garbage_sensor_3: sensor.papier
      garbage_sensor_4: sensor.restabfall
      notifier: notify.telegram_schick_home
      day_offset: '1'
      reminder_time: '20:00:00'
      reminder_message: 'Folgender Müll wird morgen abgeholt:'
      reminder_title: "\U0001F5D1️ Müllabfuhr Erinnerung"
